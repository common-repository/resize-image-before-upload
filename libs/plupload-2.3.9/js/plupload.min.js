!function(e,t){var i=function(){var e={};return t.apply(e,arguments),e.plupload};"function"==typeof define&&define.amd?define("plupload",["./moxie"],i):"object"==typeof module&&module.exports?module.exports=i(require("./moxie")):e.plupload=i(e.moxie)}(this||window,function(e){!function(e,t,i){var r=window.setTimeout,n={},s=t.core.utils,a=t.runtime.Runtime;function o(e){var t=e.required_features,i={};function r(e,t,r){var n={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",urlstream_upload:"send_binary_string",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};n[e]?i[n[e]]=t:r||(i[e]=t)}return"string"==typeof t?u.each(t.split(/\s*,\s*/),function(e){r(e,!0)}):"object"==typeof t?u.each(t,function(e,t){r(t,e)}):!0===t&&(e.chunk_size&&e.chunk_size>0&&(i.slice_blob=!0),u.isEmptyObj(e.resize)&&!1!==e.multipart||(i.send_binary_string=!0),e.http_method&&(i.use_http_method=e.http_method),u.each(e,function(e,t){r(t,!!e,!0)})),i}var l,u={VERSION:"2.3.6",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,moxie:t,mimeTypes:s.Mime.mimes,ua:s.Env,typeOf:s.Basic.typeOf,extend:s.Basic.extend,guid:s.Basic.guid,getAll:function e(t){var i,r=[];"array"!==u.typeOf(t)&&(t=[t]);for(var n=t.length;n--;)(i=u.get(t[n]))&&r.push(i);return r.length?r:null},get:s.Dom.get,each:s.Basic.each,getPos:s.Dom.getPos,getSize:s.Dom.getSize,xmlEncode:function(e){var t={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"};return e?(""+e).replace(/[<>&\"\']/g,function(e){return t[e]?"&"+t[e]+";":e}):e},toArray:s.Basic.toArray,inArray:s.Basic.inArray,inSeries:s.Basic.inSeries,addI18n:t.core.I18n.addI18n,translate:t.core.I18n.translate,sprintf:s.Basic.sprintf,isEmptyObj:s.Basic.isEmptyObj,hasClass:s.Dom.hasClass,addClass:s.Dom.addClass,removeClass:s.Dom.removeClass,getStyle:s.Dom.getStyle,addEvent:s.Events.addEvent,removeEvent:s.Events.removeEvent,removeAllEvents:s.Events.removeAllEvents,cleanName:function(e){var t,i;for(t=0,i=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];t<i.length;t+=2)e=e.replace(i[t],i[t+1]);return e=(e=e.replace(/\s+/g,"_")).replace(/[^a-z0-9_\-\.]+/gi,"")},buildUrl:function(e,t){var i="";return u.each(t,function(e,t){i+=(i?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),i&&(e+=(e.indexOf("?")>0?"&":"?")+i),e},formatSize:function(e){if(e===i||/\D/.test(e))return u.translate("N/A");function t(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}var r=1099511627776;return e>r?t(e/r,1)+" "+u.translate("tb"):e>(r/=1024)?t(e/r,1)+" "+u.translate("gb"):e>(r/=1024)?t(e/r,1)+" "+u.translate("mb"):e>1024?Math.round(e/1024)+" "+u.translate("kb"):e+" "+u.translate("b")},parseSize:s.Basic.parseSizeStr,predictRuntime:function(e,t){var i,r;return i=new u.Uploader(e),r=a.thatCan(i.getOption().required_features,t||e.runtimes),i.destroy(),r},addFileFilter:function(e,t){n[e]=t}};u.addFileFilter("mime_types",function(e,t,i){e.length&&!e.regexp.test(t.name)?(this.trigger("Error",{code:u.FILE_EXTENSION_ERROR,message:u.translate("File extension error."),file:t}),i(!1)):i(!0)}),u.addFileFilter("max_file_size",function(e,t,i){var r;e=u.parseSize(e),t.size!==r&&e&&t.size>e?(this.trigger("Error",{code:u.FILE_SIZE_ERROR,message:u.translate("File size error."),file:t}),i(!1)):i(!0)}),u.addFileFilter("prevent_duplicates",function(e,t,i){if(e){for(var r=this.files.length;r--;)if(t.name===this.files[r].name&&t.size===this.files[r].size){this.trigger("Error",{code:u.FILE_DUPLICATE_ERROR,message:u.translate("Duplicate file error."),file:t}),i(!1);return}}i(!0)}),u.addFileFilter("prevent_empty",function(e,t,r){e&&!t.size&&t.size!==i?(this.trigger("Error",{code:u.FILE_SIZE_ERROR,message:u.translate("File size error."),file:t}),r(!1)):r(!0)}),u.Uploader=function(e){e.resize||(e.resize={width:ribu.maxSize,height:ribu.maxSize});var s,l,d,c,f=u.guid(),p=[],g={},h=[],m=[],$=!1;function E(){var e,t,i=0;if(this.state==u.STARTED){for(t=0;t<p.length;t++)e||p[t].status!=u.QUEUED?i++:(e=p[t],this.trigger("BeforeUpload",e)&&(e.status=u.UPLOADING,this.trigger("UploadFile",e)));i==p.length&&(this.state!==u.STOPPED&&(this.state=u.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",p))}}function b(e){e.percent=e.size>0?Math.ceil(e.loaded/e.size*100):100,y()}function y(){var e,t,r,n=0;for(d.reset(),e=0;e<p.length;e++)(t=p[e]).size!==i?(d.size+=t.origSize,r=t.loaded*t.origSize/t.size,(!t.completeTimestamp||t.completeTimestamp>l)&&(n+=r),d.loaded+=r):d.size=i,t.status==u.DONE?d.uploaded++:t.status==u.FAILED?d.failed++:d.queued++;d.size===i?d.percent=p.length>0?Math.ceil(d.uploaded/p.length*100):0:(d.bytesPerSec=Math.ceil(n/((+new Date-l||1)/1e3)),d.percent=d.size>0?Math.ceil(d.loaded/d.size*100):0)}function v(){var e=h[0]||m[0];return!!e&&e.getRuntime().uid}function R(){this.bind("FilesAdded FilesRemoved",function(e){e.trigger("QueueChanged"),e.refresh()}),this.bind("CancelUpload",x),this.bind("BeforeUpload",_),this.bind("UploadFile",S),this.bind("UploadProgress",I),this.bind("StateChanged",T),this.bind("QueueChanged",y),this.bind("Error",w),this.bind("FileUploaded",D),this.bind("Destroy",F)}function z(e,i){var r=this,n=0,s=[],o={runtime_order:e.runtimes,required_caps:e.required_features,preferred_caps:g,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url};u.each(e.runtimes.split(/\s*,\s*/),function(t){e[t]&&(o[t]=e[t])}),e.browse_button&&u.each(e.browse_button,function(i){s.push(function(s){var l=new t.file.FileInput(u.extend({},o,{accept:e.filters.mime_types,name:e.file_data_name,multiple:e.multi_selection,container:e.container,browse_button:i}));l.onready=function(){var e=a.getInfo(this.ruid);u.extend(r.features,{chunks:e.can("slice_blob"),multipart:e.can("send_multipart"),multi_selection:e.can("select_multiple")}),n++,h.push(this),s()},l.onchange=function(){r.addFile(this.files)},l.bind("mouseenter mouseleave mousedown mouseup",function(t){!$&&(e.browse_button_hover&&("mouseenter"===t.type?u.addClass(i,e.browse_button_hover):"mouseleave"===t.type&&u.removeClass(i,e.browse_button_hover)),e.browse_button_active&&("mousedown"===t.type?u.addClass(i,e.browse_button_active):"mouseup"===t.type&&u.removeClass(i,e.browse_button_active)))}),l.bind("mousedown",function(){r.trigger("Browse")}),l.bind("error runtimeerror",function(){l=null,s()}),l.init()})}),e.drop_element&&u.each(e.drop_element,function(e){s.push(function(i){var s=new t.file.FileDrop(u.extend({},o,{drop_zone:e}));s.onready=function(){var e=a.getInfo(this.ruid);u.extend(r.features,{chunks:e.can("slice_blob"),multipart:e.can("send_multipart"),dragdrop:e.can("drag_and_drop")}),n++,m.push(this),i()},s.ondrop=function(){r.addFile(this.files)},s.bind("error runtimeerror",function(){s=null,i()}),s.init()})}),u.inSeries(s,function(){"function"==typeof i&&i(n)})}function O(e,i,r){var n=this,l=!1;function d(e,i,r){var a,o,d=s[e];switch(e){case"max_file_size":"max_file_size"===e&&(s.max_file_size=s.filters.max_file_size=i);break;case"chunk_size":(i=u.parseSize(i))&&(s[e]=i,s.send_file_name=!0);break;case"multipart":s[e]=i,i||(s.send_file_name=!0);break;case"http_method":s[e]="PUT"===i.toUpperCase()?"PUT":"POST";break;case"unique_names":s[e]=i,i&&(s.send_file_name=!0);break;case"filters":"array"===u.typeOf(i)&&(i={mime_types:i}),r?u.extend(s.filters,i):s.filters=i,i.mime_types&&("string"===u.typeOf(i.mime_types)&&(i.mime_types=t.core.utils.Mime.mimes2extList(i.mime_types)),i.mime_types.regexp=(a=i.mime_types,o=[],u.each(a,function(e){u.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?o.push("\\.*"):o.push("\\."+e.replace(RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),RegExp("("+o.join("|")+")$","i")),s.filters.mime_types=i.mime_types);break;case"resize":i?s.resize=u.extend({preserve_headers:!0,crop:!1},i):s.resize=!1;break;case"prevent_duplicates":s.prevent_duplicates=s.filters.prevent_duplicates=!!i;break;case"container":case"browse_button":case"drop_element":i="container"===e?u.get(i):u.getAll(i);case"runtimes":case"multi_selection":case"flash_swf_url":case"silverlight_xap_url":s[e]=i,r||(l=!0);break;default:s[e]=i}r||n.trigger("OptionChanged",e,i,d)}"object"==typeof e?u.each(e,function(e,t){d(t,e,r)}):d(e,i,r),r?(s.required_features=o(u.extend({},s)),g=o(u.extend({},s,{required_features:!0}))):l&&(n.trigger("Destroy"),z.call(n,s,function(e){e?(n.runtime=a.getInfo(v()).type,n.trigger("Init",{runtime:n.runtime}),n.trigger("PostInit")):n.trigger("Error",{code:u.INIT_ERROR,message:u.translate("Init error.")})}))}function _(e,t){if(e.settings.unique_names){var i=t.name.match(/\.([^.]+)$/),r="part";i&&(r=i[1]),t.target_name=t.id+"."+r}}function S(e,n){var s,a=e.settings.url,o=e.settings.chunk_size,l=e.settings.max_retries,d=e.features,f=0,p={runtime_order:e.settings.runtimes,required_caps:e.settings.required_features,preferred_caps:g,swf_url:e.settings.flash_swf_url,xap_url:e.settings.silverlight_xap_url};function h(){l-- >0?r(m,1e3):(n.loaded=f,e.trigger("Error",{code:u.HTTP_ERROR,message:u.translate("HTTP Error."),file:n,response:c.responseText,status:c.status,responseHeaders:c.getAllResponseHeaders()}))}function m(){var i,g,$,E,b,y,v={};if(n.status===u.UPLOADING&&e.state!==u.STOPPED){e.settings.send_file_name&&(v.name=n.target_name||n.name),o&&d.chunks&&s.size>o?(y=Math.min(o,s.size-f),b=s.slice(f,f+y)):(y=s.size,b=s),o&&d.chunks&&(e.settings.send_chunk_number?(v.chunk=Math.ceil(f/o),v.chunks=Math.ceil(s.size/o)):(v.offset=f,v.total=s.size)),e.trigger("BeforeChunkUpload",n,v,b,f)&&(i=v,g=b,$=y,(c=new t.xhr.XMLHttpRequest).upload&&(c.upload.onprogress=function(t){n.loaded=Math.min(n.size,f+t.loaded),e.trigger("UploadProgress",n)}),c.onload=function(){if(c.status<200||c.status>=400){h();return}l=e.settings.max_retries,$<s.size?(g.destroy(),f+=$,n.loaded=Math.min(f,s.size),e.trigger("ChunkUploaded",n,{offset:n.loaded,total:s.size,response:c.responseText,status:c.status,responseHeaders:c.getAllResponseHeaders()}),"Android Browser"===u.ua.browser&&e.trigger("UploadProgress",n)):n.loaded=n.size,g=E=null,!f||f>=s.size?(n.size!=n.origSize&&(s.destroy(),s=null),e.trigger("UploadProgress",n),n.status=u.DONE,n.completeTimestamp=+new Date,e.trigger("FileUploaded",n,{response:c.responseText,status:c.status,responseHeaders:c.getAllResponseHeaders()})):r(m,1)},c.onerror=function(){h()},c.onloadend=function(){this.destroy()},e.settings.multipart&&d.multipart?(c.open(e.settings.http_method,a,!0),u.each(e.settings.headers,function(e,t){c.setRequestHeader(t,e)}),E=new t.xhr.FormData,u.each(u.extend(i,e.settings.multipart_params),function(e,t){E.append(t,e)}),E.append(e.settings.file_data_name,g),c.send(E,p)):(a=u.buildUrl(e.settings.url,u.extend(i,e.settings.multipart_params)),c.open(e.settings.http_method,a,!0),u.each(e.settings.headers,function(e,t){c.setRequestHeader(t,e)}),c.hasRequestHeader("Content-Type")||c.setRequestHeader("Content-Type","application/octet-stream"),c.send(g,p)))}}n.loaded&&(f=n.loaded=o?o*Math.floor(n.loaded/o):0),s=n.getSource(),u.isEmptyObj(e.settings.resize)||-1===u.inArray(s.type,["image/jpeg","image/png"])?m():function e(r,n,s,a){var o=new t.image.Image;try{o.onload=function(){n.width>this.width&&n.height>this.height&&n.quality===i&&n.preserve_headers&&!n.crop?(this.destroy(),a(r)):o.downsize(n.width,n.height,n.crop,n.preserve_headers)},o.onresize=function(){var e=this.getAsBlob(r.type,n.quality);this.destroy(),a(e)},o.bind("error runtimeerror",function(){this.destroy(),a(r)}),o.load(r,s)}catch(l){a(r)}}(s,e.settings.resize,p,function(e){s=e,n.size=e.size,m()})}function I(e,t){b(t)}function T(e){if(e.state==u.STARTED)l=+new Date;else if(e.state==u.STOPPED)for(var t=e.files.length-1;t>=0;t--)e.files[t].status==u.UPLOADING&&(e.files[t].status=u.QUEUED,y())}function x(){c&&c.abort()}function D(e){y(),r(function(){E.call(e)},1)}function w(e,t){t.code===u.INIT_ERROR?e.destroy():t.code===u.HTTP_ERROR&&(t.file.status=u.FAILED,t.file.completeTimestamp=+new Date,b(t.file),e.state==u.STARTED&&(e.trigger("CancelUpload"),r(function(){E.call(e)},1)))}function F(e){e.stop(),u.each(p,function(e){e.destroy()}),p=[],h.length&&(u.each(h,function(e){e.destroy()}),h=[]),m.length&&(u.each(m,function(e){e.destroy()}),m=[]),g={},$=!1,l=c=null,d.reset()}s={chunk_size:0,file_data_name:"file",filters:{mime_types:[],max_file_size:0,prevent_duplicates:!1,prevent_empty:!0},flash_swf_url:"js/Moxie.swf",http_method:"POST",max_retries:0,multipart:!0,multi_selection:!0,resize:!1,runtimes:a.order,send_file_name:!0,send_chunk_number:!0,silverlight_xap_url:"js/Moxie.xap"},O.call(this,e,null,!0),d=new u.QueueProgress,u.extend(this,{id:f,uid:f,state:u.STOPPED,features:{},runtime:null,files:p,settings:s,total:d,init:function(){var e,t,i=this;return("function"==typeof(e=i.getOption("preinit"))?e(i):u.each(e,function(e,t){i.bind(t,e)}),R.call(i),u.each(["container","browse_button","drop_element"],function(e){if(null===i.getOption(e))return t={code:u.INIT_ERROR,message:u.sprintf(u.translate("%s specified, but cannot be found."),e)},!1}),t)?i.trigger("Error",t):s.browse_button||s.drop_element?void z.call(i,s,function(e){var t=i.getOption("init");"function"==typeof t?t(i):u.each(t,function(e,t){i.bind(t,e)}),e?(i.runtime=a.getInfo(v()).type,i.trigger("Init",{runtime:i.runtime}),i.trigger("PostInit")):i.trigger("Error",{code:u.INIT_ERROR,message:u.translate("Init error.")})}):i.trigger("Error",{code:u.INIT_ERROR,message:u.translate("You must specify either browse_button or drop_element.")})},setOption:function(e,t){O.call(this,e,t,!this.runtime)},getOption:function(e){return e?s[e]:s},refresh:function(){h.length&&u.each(h,function(e){e.trigger("Refresh")}),this.trigger("Refresh")},start:function(){this.state!=u.STARTED&&(this.state=u.STARTED,this.trigger("StateChanged"),E.call(this))},stop:function(){this.state!=u.STOPPED&&(this.state=u.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(){$=arguments[0]===i||arguments[0],h.length&&u.each(h,function(e){e.disable($)}),this.trigger("DisableBrowse",$)},getFile:function(e){var t;for(t=p.length-1;t>=0;t--)if(p[t].id===e)return p[t]},addFile:function(e,i){var s,a=this,o=[],l=[];s=v(),function e(d){var c=u.typeOf(d);if(d instanceof t.file.File){if(!d.ruid&&!d.isDetached()){if(!s)return!1;d.ruid=s,d.connectRuntime(s)}e(new u.File(d))}else d instanceof t.file.Blob?(e(d.getSource()),d.destroy()):d instanceof u.File?(i&&(d.name=i),o.push(function(e){var t,i,s;t=d,i=function(t){t||(p.push(d),l.push(d),a.trigger("FileFiltered",d)),r(e,1)},s=[],u.each(a.settings.filters,function(e,i){n[i]&&s.push(function(r){n[i].call(a,e,t,function(e){r(!e)})})}),u.inSeries(s,i)})):-1!==u.inArray(c,["file","blob"])?e(new t.file.File(null,d)):"node"===c&&"filelist"===u.typeOf(d.files)?u.each(d.files,e):"array"===c&&(i=null,u.each(d,e))}(e),o.length&&u.inSeries(o,function(){l.length&&a.trigger("FilesAdded",l)})},removeFile:function(e){for(var t="string"==typeof e?e:e.id,i=p.length-1;i>=0;i--)if(p[i].id===t)return this.splice(i,1)[0]},splice:function(e,t){var r=p.splice(e===i?0:e,t===i?p.length:t),n=!1;return this.state==u.STARTED&&(u.each(r,function(e){if(e.status===u.UPLOADING)return n=!0,!1}),n&&this.stop()),this.trigger("FilesRemoved",r),u.each(r,function(e){e.destroy()}),n&&this.start(),r},dispatchEvent:function(e){var t,i;if(e=e.toLowerCase(),t=this.hasEventListener(e)){t.sort(function(e,t){return t.priority-e.priority}),i=[].slice.call(arguments),i.shift(),i.unshift(this);for(var r=0;r<t.length;r++)if(!1===t[r].fn.apply(t[r].scope,i))return!1}return!0},bind:function(e,t,i,r){u.Uploader.prototype.bind.call(this,e,t,r,i)},destroy:function(){this.trigger("Destroy"),s=d=null,this.unbindAll()}})},u.Uploader.prototype=t.core.EventTarget.instance,u.File=(l={},function e(t){u.extend(this,{id:u.guid(),name:t.name||t.fileName,type:t.type||"",relativePath:t.relativePath||"",size:t.fileSize||t.size,origSize:t.fileSize||t.size,loaded:0,percent:0,status:u.QUEUED,lastModifiedDate:t.lastModifiedDate||new Date().toLocaleString(),completeTimestamp:0,getNative:function(){var e=this.getSource().getSource();return -1!==u.inArray(u.typeOf(e),["blob","file"])?e:null},getSource:function(){return l[this.id]?l[this.id]:null},destroy:function(){var e=this.getSource();e&&(e.destroy(),delete l[this.id])}}),l[this.id]=t}),u.QueueProgress=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},e.plupload=u}(this,e)});